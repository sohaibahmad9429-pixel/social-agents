FROM python:3.11-slim

# Prevent interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive

# Install system dependencies for display, VNC, and Playwright
RUN apt-get update && apt-get install -y --no-install-recommends \
    # Virtual display
    xvfb \
    # VNC server
    x11vnc \
    # Window manager (lightweight)
    fluxbox \
    # Utilities
    net-tools \
    procps \
    git \
    curl \
    # Playwright Chromium dependencies
    libnss3 \
    libnspr4 \
    libatk1.0-0 \
    libatk-bridge2.0-0 \
    libcups2 \
    libatspi2.0-0 \
    libxcomposite1 \
    libxdamage1 \
    libxrandr2 \
    libgbm1 \
    libxkbcommon0 \
    libpango-1.0-0 \
    libcairo2 \
    libasound2 \
    libxshmfence1 \
    libglu1-mesa \
    && rm -rf /var/lib/apt/lists/*

# Install noVNC for browser-based VNC access
RUN git clone --depth 1 --branch v1.5.0 https://github.com/novnc/noVNC.git /opt/noVNC && \
    git clone --depth 1 --branch v0.12.0 https://github.com/novnc/websockify /opt/noVNC/utils/websockify && \
    ln -s /opt/noVNC/vnc.html /opt/noVNC/index.html

# Set working directory
WORKDIR /app

# Copy requirements and install Python dependencies
COPY pyproject.toml ./
RUN pip install --no-cache-dir uv && \
    uv pip install --system -e .

# Install Playwright and Chromium browser
RUN pip install playwright && \
    playwright install chromium && \
    playwright install-deps chromium

# Copy startup scripts
COPY docker/scripts/ /scripts/
RUN chmod +x /scripts/*.sh

# Copy application code
COPY src/ ./src/

# Environment variables for display
ENV DISPLAY=:99
ENV DISPLAY_WIDTH=1280
ENV DISPLAY_HEIGHT=720

# Expose ports
# 8000 - FastAPI
# 5900 - VNC
# 6080 - noVNC (WebSocket)
EXPOSE 8000 5900 6080

# Start all services
CMD ["/scripts/start_all.sh"]
